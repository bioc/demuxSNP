---
title: "my-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(SNPcheck)
library(ComplexHeatmap)
library(viridisLite)
library(SingleCellExperiment)
```

Demultiplexing in scRNAseq involves assigning cells back to their original sample, where cells from different donors, treatments types or physiological locations are sequenced together.

Here, we aim to leverage information from both modalities to minimise misclassification and maximise yield.
We note that as with other SNP based methods, performance is dependent on genetic differences between samples.

Novel features:

* Uses both cell hashing and SNP data
* Selects SNPs based on gene expression to reduce noise and computational cost


## Preprocessing

we will begin with pre-processing the data, this includes finding the most commonly expressed genes in our dataset, then subsetting the vcf file to retain only snps located in these commonly expressed genes.

````{r}

load("../Data/sce.rda")
load("../Data/snps.rda")
load("../Data/vcf.rda")

````


````{r}

top_genes<-common_genes(sce = sce)
subset_vcf(vcf,sce,top_genes = top_genes)
sce<-consensus_calls(sce)

````



We also run a number of hashing based demultiplexing algorithms.
Their consensus will be used as training labels later on.



This vcf can then be used as input to VarTrix (https://github.com/10XGenomics/vartrix), along with your .bam, barcodes and reference genome.



## Variant Calling (VartTrix)

Variant calling is not done within the package. 
Instead, we refer the reader to VartTrix, where they can use the subsetted .vcf file along with their .bam, barcodes.tsv and reference genome to call SNPs.

A sample vartrix command looks like the following:

````{r}



````

Using the SNPs data from Vartrix and the classifications from the HTO algorithm, we train a supervised learning algorithm.

## Cell reassignment, visualisation and evaluation

````{r}

sce<-add_snps(sce,snps)

altExp(sce,"SNP")

sce<-reassign(sce,k=5)

table(sce$knn)
````




````{r fig.width=7,fig.height=6}
colors = structure(viridis(n=3), names = c("-1","0", "1"))

Heatmap(counts(altExp(sce[,sce$seurat=="Negative"],"SNP")),column_split=sce$knn[sce$seurat=="Negative"],cluster_rows=FALSE,show_column_names = FALSE,cluster_column_slices = FALSE,column_names_rot = 45,column_title_rot = -45,row_title = "SNPs",col=colors)

Heatmap(counts(altExp(sce,"SNP")),column_split=sce$knn,cluster_rows=FALSE,show_column_names = FALSE,cluster_column_slices = FALSE,row_title = "SNPs",col=colors)


````
